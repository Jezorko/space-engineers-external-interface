<html lang="en">
<body>
<div id="openInFullScreenContainer" style="position: absolute; width: 50%; z-index: 999; background:#ef8733">
  <div>Would you like to open in fullscreen?</div>
  <button id="openInFullScreenButton">Yes</button>
  <button id="removeFullScreenContainerButton">Nope</button>
</div>
<div id="mainContainer" style="width: 100%; height: 100%; margin-left: 0; margin-top: 0;">
</div>
</body>
<script type="module">
  import {getInterface} from "./api/interfaces.js";
  import {getTemplate} from "./api/templates.js";
  import {triggerAction} from "./api/actions.js";

  const mainContainer = document.getElementById('mainContainer');
  const openInFullScreenContainer = document.getElementById('openInFullScreenContainer');
  const openInFullScreenButton = document.getElementById('openInFullScreenButton');
  const removeFullScreenContainerButton = document.getElementById('removeFullScreenContainerButton');

  const soundContainers = {};

  const openFullscreen = () => {
    if (mainContainer.requestFullscreen) {
      mainContainer.requestFullscreen();
    } else if (mainContainer.webkitRequestFullscreen) { /* Safari */
      mainContainer.webkitRequestFullscreen();
    } else if (mainContainer.msRequestFullscreen) { /* IE11 */
      mainContainer.msRequestFullscreen();
    }
  }

  const closeFullscreen = () => {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) { /* Safari */
      document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) { /* IE11 */
      document.msExitFullscreen();
    }
  }

  openInFullScreenButton.onclick = openFullscreen;
  removeFullScreenContainerButton.onclick = () => document.body.removeChild(openInFullScreenContainer);

  const urlParams = new URLSearchParams(window.location.search);
  const interfaceName = urlParams.get('name');
  const tabContainers = [];
  const makeTabVisible = (tabId) => {
    tabContainers.forEach(tabContainer => {
      const currentTabId = tabContainer.id.substr(4);
      if (tabId === currentTabId) {
        tabContainer.style.display = 'flex';
      } else {
        tabContainer.style.display = 'none';
      }
    });
  };

  const pressKey = (action) => {
    console.log('pressing key', action);
    triggerAction(action);
  }

  const openTab = (action) => {
    console.log('opening tab', action);
    triggerAction(action).then(() => {
      const tabId = action.substring(9);
      makeTabVisible(tabId);
    });
  }

  getInterface(interfaceName).then(async theInterface => {
    const template = await getTemplate(theInterface.templateName);

    if (template.importFonts) {
      template.importFonts.forEach(fontUrl => {
        const link = document.createElement('link');
        link.setAttribute('rel', 'stylesheet');
        link.setAttribute('type', 'text/css');
        link.setAttribute('href', fontUrl);
        document.head.appendChild(link);
      });
    }

    let firstTabId = -1;
    for (const tabId in template.tabs) {
      if (template.tabs.hasOwnProperty(tabId)) {
        if (firstTabId === -1) {
          firstTabId = tabId;
        }
        const tab = template.tabs[tabId];

        const tabContainer = document.createElement('div');
        tabContainers.push(tabContainer);
        mainContainer.appendChild(tabContainer);
        tabContainer.id = `tab-${tabId}`;
        tabContainer.className = 'tab';
        tabContainer.style.width = '100%';
        tabContainer.style.height = '100%';
        tabContainer.style.backgroundColor = template.backgroundColor;

        tab.forEach(tabElement => {
          const elementConfiguration = theInterface.elementsConfiguration[tabElement.id];

          const tabElementContainer = document.createElement(tabElement.type === 'BUTTON' ? 'button' : 'div');
          tabContainer.appendChild(tabElementContainer);
          tabElementContainer.id = `tab-element-${tabElement.id}`;
          tabElementContainer.class = 'tab-element';

          const elementText = elementConfiguration
              ? (elementConfiguration.text ? elementConfiguration.text : tabElement.defaultText)
              : tabElement.defaultText;

          const elementFontSize = elementConfiguration
              ? (elementConfiguration.fontSize ? elementConfiguration.fontSize : tabElement.fontSize)
              : tabElement.fontSize;

          tabElementContainer.textContent = elementText;
          tabElementContainer.style.fontFamily = tabElement.font ? tabElement.font : template.defaultFont;
          tabElementContainer.style.position = 'absolute';
          tabElementContainer.style.top = `${tabElement.position.top}%`;
          tabElementContainer.style.left = `${tabElement.position.left}%`;
          tabElementContainer.style.width = `${tabElement.size.width}%`;
          tabElementContainer.style.height = `${tabElement.size.height}%`;
          tabElementContainer.style.fontcolor = tabElement.color.text;
          tabElementContainer.style.fontSize = elementFontSize;
          tabElementContainer.style.background = tabElement.color.background;
          tabElementContainer.style.borderColor = tabElement.color.border;
          tabElementContainer.style.border = tabElement.border.style;
          tabElementContainer.style.borderWidth = tabElement.border.size;

          const elementAction = elementConfiguration
              ? (elementConfiguration.action ? elementConfiguration.action : tabElement.defaultAction)
              : tabElement.defaultAction;

          let playSound = () => {
          };
          const soundLink = tabElement.sound;
          if (soundLink && soundLink !== '') {
            let soundContainer;
            if (!(soundLink in soundContainers)) {
              soundContainer = document.createElement('audio');
              soundContainer.id = `tab-element-${tabElement.id}-sound`;
              soundContainer.src = soundLink;
              soundContainer.autoplay = false;
              document.head.appendChild(soundContainer);
              soundContainers[soundLink] = soundContainer;
              console.log('created sound container with ID', soundContainer.id);
            } else {
              soundContainer = soundContainers[soundLink];
              console.log('reusing existing sound container', tabElementContainer.id, soundContainer.id);
            }

            playSound = () => soundContainer.play();
          }

          if (!elementAction) {
            console.log(`no action registered for element ${tabElement.id}`);
          } else if (elementAction.startsWith('PRESS_KEY_')) {
            tabElementContainer.onclick = () => {
              playSound();
              pressKey(elementAction);
            };
          } else if (elementAction.startsWith('OPEN_TAB_')) {
            tabElementContainer.onclick = () => {
              playSound();
              openTab(elementAction);
            };
          } else {
            console.error('unknown action', elementAction);
          }
        })
      }
    }
    makeTabVisible(firstTabId);
  }).catch(error => {
    mainContainer.textContent = `Failed to fetch interface or template: ${error}`
  });

</script>
</html>